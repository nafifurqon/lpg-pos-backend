# Implementation Plan — Standardize Response Format

## Overview

| Field               | Value                                                          |
|---------------------|----------------------------------------------------------------|
| **Plan ID**         | BE-PLAN-02                                                     |
| **Related Story**   | `2026-02-27 17.10.58-TASK-Standardize Response Format-LPG-1`   |
| **Author**          | —                                                              |
| **Date**            | 2026-02-27                                                     |
| **Status**          | Done                                                           |

## Goal

Introduce a global response envelope across all NestJS endpoints so that every HTTP response follows a predictable shape. Success responses are wrapped in `{ message, result }`. Error responses always use `{ messages: string[], error: string }` — `statusCode` is omitted from the body since it is already communicated via the HTTP status header.

## Scope

### In Scope

- New files under `src/common/` (decorator, interceptor, filter)
- Global registration in `src/main.ts`
- Auth controller decorated with `@ResponseMessage()`
- Auth service test throw removed

### Out of Scope

- Frontend types and API layer (separate task)
- Non-HTTP exceptions (unhandled 500s)
- Pagination implementation (covered when list endpoints are built)

## Affected Files

| File                                                  | Change Type | Notes                                                   |
|-------------------------------------------------------|-------------|---------------------------------------------------------|
| `src/common/decorators/response-message.decorator.ts` | Create      | `@ResponseMessage(msg)` using `SetMetadata`             |
| `src/common/interceptors/transform.interceptor.ts`    | Create      | Wraps success response in `{ message, result }`         |
| `src/common/filters/http-exception.filter.ts`         | Create      | Normalizes errors to `{ messages: string[], error }`    |
| `src/main.ts`                                         | Modify      | Register global filter and interceptor                  |
| `src/auth/auth.controller.ts`                         | Modify      | Add `@ResponseMessage()` to handlers, fix logout status |
| `src/auth/auth.service.ts`                            | Modify      | Remove `throw new BadRequestException('Test')`          |

## Implementation Steps

1. **Decorator** — Create `@ResponseMessage(msg: string)` using `SetMetadata('response_message', msg)` in `src/common/decorators/response-message.decorator.ts`

2. **TransformInterceptor** — Create `src/common/interceptors/transform.interceptor.ts`:
   - Implements `NestInterceptor`
   - Injects `Reflector` via constructor
   - Reads `response_message` metadata from the current handler/class
   - Wraps response data: single resource → `{ message, result: data }`; list (data shape `{ data: T[], metadata }`) → `{ message, result: data, metadata }`

3. **HttpExceptionFilter** — Create `src/common/filters/http-exception.filter.ts`:
   - Decorated with `@Catch(HttpException)`
   - Extracts `message` from exception response, normalizes to `messages: string[]`
   - Extracts `error` field (string), omits `statusCode` from body
   - Returns `res.status(status).json({ messages, error })`

4. **Register globally** — Update `src/main.ts`:
   - `const reflector = app.get(Reflector)`
   - `app.useGlobalFilters(new HttpExceptionFilter())`
   - `app.useGlobalInterceptors(new TransformInterceptor(reflector))`

5. **Decorate auth controller** — Update `src/auth/auth.controller.ts`:
   - Import `@ResponseMessage` decorator
   - Add `@ResponseMessage('Berhasil mendaftar')` to `register()`
   - Add `@ResponseMessage('Berhasil masuk')` to `login()`
   - Add `@ResponseMessage('Berhasil masuk dengan Google')` to `googleLogin()`
   - Add `@ResponseMessage('Token berhasil diperbarui')` to `refresh()`
   - Add `@ResponseMessage('Berhasil keluar')` to `logout()`, remove `@HttpCode(HttpStatus.NO_CONTENT)`

6. **Remove test throw** — Delete `throw new BadRequestException('Test')` from `src/auth/auth.service.ts`

7. **Verify** — Run `npx tsc --noEmit` and smoke-test all auth endpoints with `curl`

## API Response Shape Reference

### Success — Single Resource

```json
{
  "message": "Berhasil mendaftar",
  "result": {
    "access_token": "...",
    "refresh_token": "..."
  }
}
```

### Success — List (future endpoints)

```json
{
  "message": "Berhasil mengambil data",
  "result": [...],
  "metadata": {
    "total_items": 42,
    "total_pages": 5
  }
}
```

### Error

```json
{
  "messages": ["Email wajib diisi", "Format email tidak valid"],
  "error": "Bad Request"
}
```
