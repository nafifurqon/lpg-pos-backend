# Implementation Plan — Register Shop

## Overview

| Field               | Value                                                 |
|---------------------|-------------------------------------------------------|
| **Plan ID**         | BE-PLAN-03                                            |
| **Feature**         | 01-register-login                                     |
| **Related Stories** | LPG-2 / BE-05                                         |
| **Author**          | —                                                     |
| **Date**            | 2026-02-28                                            |
| **Status**          | In Progress                                           |

## Goal

Implement `POST /shops` — a protected endpoint that allows an authenticated owner to register exactly one shop. The shop entity is stored in a new `shops` table with a UNIQUE constraint on `owner_id`, enforcing the one-shop-per-owner rule at the database level as well as the service layer.

## Scope

### In Scope

- `Shop` entity and TypeORM migration
- `CreateShopDto` with `class-validator` decorators
- `ShopsService.createShop()` with conflict check
- `ShopsController` wired to `POST /shops`, protected by `JwtAccessGuard`
- `ShopsModule` registered in `AppModule`

### Out of Scope

- Shop update, delete, or list endpoints
- Multiple shops per owner
- Frontend integration

## Affected Files

| File                                        | Change Type | Notes                                           |
|---------------------------------------------|-------------|-------------------------------------------------|
| `src/shops/entities/shop.entity.ts`         | Create      | TypeORM entity; FK `owner_id` → `users.id`      |
| `src/shops/dto/create-shop.dto.ts`          | Create      | Validation DTO                                  |
| `src/shops/shops.service.ts`                | Create      | Business logic; conflict check                  |
| `src/shops/shops.controller.ts`             | Create      | `POST /shops`; JWT-protected                    |
| `src/shops/shops.module.ts`                 | Create      | Module registration                             |
| `src/users/entities/user.entity.ts`         | Modify      | Add inverse `@OneToOne` relation to `Shop`      |
| `src/migrations/<ts>-CreateShopsTable.ts`   | Create      | Auto-generated via `migration:generate`         |
| `src/app.module.ts`                         | Modify      | Import `ShopsModule`                            |

## Implementation Steps

1. **Entity** — Create `Shop` entity with `@OneToOne(() => User)` + `@JoinColumn({ name: 'owner_id' })` and UNIQUE constraint
2. **User entity** — Add inverse `@OneToOne` relation pointing back to `Shop`
3. **Migration** — Run `npm run migration:generate -- src/migrations/CreateShopsTable`, review output
4. **Apply Migration** — Run `npm run migration:run`
5. **DTO** — Create `CreateShopDto` with `class-validator` decorators
6. **Service** — Implement `createShop(ownerId, dto)` with `ConflictException` on duplicate
7. **Controller** — Wire `POST /shops` with `JwtAccessGuard`, `@CurrentUser()`, `@ResponseMessage()`
8. **Module** — Register in `ShopsModule` and import in `AppModule`
9. **Verify** — `npx tsc --noEmit`, smoke-test endpoints

## API Changes

| Method | Path     | Auth Required | Notes                         |
|--------|----------|---------------|-------------------------------|
| POST   | `/shops` | Yes (Bearer)  | Returns `201` with shop data  |

## Environment Variable Changes

None.

## Rollback Plan

- Revert migration: `npm run migration:revert`
- Delete `src/shops/` directory
- Remove `ShopsModule` import from `AppModule`
- Revert `User` entity changes

## Verification Checklist

- [ ] `npm run migration:status` shows all migrations applied
- [ ] `POST /shops` without token returns `401`
- [ ] `POST /shops` with valid token + valid body returns `201 { message, result }`
- [ ] `POST /shops` second time same owner returns `409`
- [ ] `POST /shops` with `name` < 5 chars returns `400` with `messages[]`
- [ ] `npx tsc --noEmit` passes with zero errors
